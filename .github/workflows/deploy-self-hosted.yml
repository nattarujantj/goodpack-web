name: Deploy (Self-Hosted Runner)

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deploy target'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - web
          - server

jobs:
  deploy:
    # à¹ƒà¸Šà¹‰ self-hosted runner à¸—à¸µà¹ˆà¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¸šà¸™ Ubuntu server
    runs-on: self-hosted
    
    steps:
      - name: Determine deploy target
        id: target
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "target=${{ github.event.inputs.deploy_target }}" >> $GITHUB_OUTPUT
          else
            # Auto detect from changed files
            echo "target=all" >> $GITHUB_OUTPUT
          fi

      - name: Deploy Go Server
        if: steps.target.outputs.target == 'server' || steps.target.outputs.target == 'all'
        run: |
          echo "ğŸš€ Deploying Go Server..."
          
          cd /opt/goodpack-server
          
          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/master
          
          echo "ğŸ”¨ Building..."
          go mod tidy
          go build -o server
          
          echo "ğŸ”„ Restarting server..."
          pkill -f "./server" || true
          sleep 2
          nohup ./server > server.log 2>&1 &
          sleep 3
          
          if curl -s http://localhost:8080/api/health > /dev/null 2>&1; then
            echo "âœ… Go Server deployed!"
          else
            echo "âŒ Server health check failed"
            tail -20 server.log
            exit 1
          fi

      - name: Deploy Flutter Web
        if: steps.target.outputs.target == 'web' || steps.target.outputs.target == 'all'
        run: |
          echo "ğŸŒ Deploying Flutter Web..."
          
          cd /opt/goodpack-web
          
          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/master
          
          echo "ğŸ”¨ Building..."
          flutter pub get
          flutter build web --dart-define=API_BASE_URL="http://192.168.1.162:8080/api"
          
          echo "ğŸ“¦ Deploying to nginx..."
          sudo rm -rf /var/www/html/*
          sudo cp -r build/web/* /var/www/html/
          sudo systemctl restart nginx
          
          echo "âœ… Flutter Web deployed!"

      - name: Deployment Summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Web: http://192.168.1.162"
          echo "ğŸ“¡ API: http://192.168.1.162:8080/api"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

