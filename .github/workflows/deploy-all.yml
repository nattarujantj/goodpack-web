name: Deploy All (Full Deployment)

on:
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deploy target'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - web
          - server

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Full Deployment via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            DEPLOY_TARGET="${{ github.event.inputs.deploy_target }}"
            API_URL="http://192.168.1.162:8080/api"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Goodpack Deployment - Target: $DEPLOY_TARGET"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            deploy_server() {
              echo ""
              echo "ğŸ“¦ Deploying Go Server..."
              cd /opt/goodpack-server
              
              git fetch origin
              git reset --hard origin/master
              
              go mod tidy
              go build -o server
              
              pkill -f "./server" || true
              sleep 2
              nohup ./server > server.log 2>&1 &
              sleep 3
              
              if curl -s http://localhost:8080/api/health > /dev/null 2>&1; then
                echo "âœ… Go Server deployed successfully"
              else
                echo "âŒ Go Server failed to start"
                exit 1
              fi
            }
            
            deploy_web() {
              echo ""
              echo "ğŸŒ Deploying Flutter Web..."
              cd /opt/goodpack-web
              
              git fetch origin
              git reset --hard origin/master
              
              flutter pub get
              flutter build web --dart-define=API_BASE_URL="$API_URL"
              
              sudo rm -rf /var/www/html/*
              sudo cp -r build/web/* /var/www/html/
              sudo systemctl restart nginx
              
              echo "âœ… Flutter Web deployed successfully"
            }
            
            case $DEPLOY_TARGET in
              server)
                deploy_server
                ;;
              web)
                deploy_web
                ;;
              all)
                deploy_server
                deploy_web
                ;;
            esac
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment complete!"
            echo "ğŸŒ Web: http://192.168.1.162"
            echo "ğŸ“¡ API: http://192.168.1.162:8080/api"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

